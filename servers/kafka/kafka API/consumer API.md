### 手动提交offset
虽然自动提交offset十分简洁便利，但是由于是基于时间提交的，开发人员很难把握offset的提交时机。因此kafka还提供了手动提交offset的api。

手动提交offset的方法有两种：分别是commitSync（同步提交）和commitAsync（异步提交）。两者的相同点是，都会**将本次poll的一批数据最高的偏移量提交**；不同点是，commitSync阻塞当前线程，一直到提交成功，并且会自动失败重试（由不可控因素导致，也会出现提交失败）；而commitAsync则没有失败重试机制，故有可能提交失败。

#### 1）同步提交offset
由于同步提交offset有失败重试机制，故更加可靠。

#### 2）异步提交offset
虽然同步提交offset更可靠一些，但是由于会阻塞当前线程，直到提交成功。因此吞吐量会受到很大的影响。因此更多情况下，会选用异步提交offset的方式。

#### 3）数据漏消费和重复消费分析
无论是同步提交还是异步提交offset，都可能会造成数据的漏消费或则重复消费（提交后consumer挂掉了，没有消费数据）。先提交offset后消费，可能会造成数据的漏消费；而先消费后提交offset，有可能会造成数据的重复消费（消费数据后consumer挂掉了，没有提交offset）。


### 自定义存储offset
kafka0.9版本之前，offset存储在zookeeper，0.9版本之后，默认将offset存储在kafka的一个内置的topic中。除此之外，kafka还可以选择自定义存储offset（例如把消费数据和提交offset的操作放在同一个事务里面，保证数据和offset要么成功要么失败）。

offset的维护是相当繁琐的，因为需要考虑到消费者的Rebalance。

**当有新的消费者加入消费者组、已有的消费者退出消费者组或者所订阅的主题的分区发生变化，就会触发到分区的重新分配，重新分配的过程叫做Rebalance**。

消费者发生Rebalance之后，每个消费者消费的分区就会发生变化。因此消费者要首先获取到自己被重新分配到的分区，并且定位到每个分区最近提交的offset位置继续消费。

要实现自定义存储offset，需要借助ConsumerRebalanceListener。